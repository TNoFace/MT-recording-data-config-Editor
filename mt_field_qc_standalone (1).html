<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field QC - EMpower</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;
        
        // Lucide Icons (簡化版)
        const Upload = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>;
        const Download = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>;
        const Save = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const Check = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>;
        const X = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const AlertCircle = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;

        function MTFieldQCEditor() {
            const [data, setData] = useState(null);
            const [status, setStatus] = useState('unapproved');
            const [modified, setModified] = useState(false);

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            setData(jsonData);
                            setModified(false);
                        } catch (error) {
                            alert('JSON 檔案格式錯誤');
                        }
                    };
                    reader.readAsText(file);
                }
            };

            const handleCopy = () => {
                if (!data) return;
                const jsonString = JSON.stringify(data, null, '\t');
                
                const textarea = document.createElement('textarea');
                textarea.value = jsonString;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    document.execCommand('copy');
                    alert('JSON 內容已複製到剪貼簿！\n請貼到文字編輯器並儲存為 .json 檔案');
                } catch (err) {
                    alert('複製失敗，請使用下載功能');
                }
                
                document.body.removeChild(textarea);
            };

            const handleDownload = () => {
                if (!data) return;
                const jsonString = JSON.stringify(data, null, '\t');
                
                try {
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'recmeta.json';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 100);
                } catch (err) {
                    alert('下載失敗，請使用複製功能');
                }
            };

            const updateLayout = (field, value) => {
                setData(prev => ({
                    ...prev,
                    layout: { ...prev.layout, [field]: value }
                }));
                setModified(true);
            };

            const updateChannel = (index, field, value) => {
                setData(prev => ({
                    ...prev,
                    chconfig: {
                        ...prev.chconfig,
                        chans: prev.chconfig.chans.map((ch, i) => 
                            i === index ? { ...ch, [field]: value } : ch
                        )
                    }
                }));
                setModified(true);
            };

            if (!data) {
                return (
                    <div className="min-h-screen bg-gray-100 p-8">
                        <div className="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
                            <div className="flex items-center gap-3 mb-6">
                                <div className="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center">
                                    <span className="text-white font-bold text-xl">⚡</span>
                                </div>
                                <h1 className="text-2xl font-bold text-gray-800">Field QC - EMpower</h1>
                            </div>
                            
                            <div className="border-4 border-dashed border-gray-300 rounded-lg p-12 text-center">
                                <Upload />
                                <h2 className="text-xl font-semibold text-gray-700 mb-2">上傳 JSON 配置檔案</h2>
                                <p className="text-gray-500 mb-4">請選擇 recording.json 檔案</p>
                                <label className="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition">
                                    選擇檔案
                                    <input 
                                        type="file" 
                                        accept=".json" 
                                        onChange={handleFileUpload} 
                                        className="hidden"
                                    />
                                </label>
                            </div>
                        </div>
                    </div>
                );
            }

            const eChannels = data.chconfig.chans.filter(ch => ch.ty === 'E');
            const mChannels = data.chconfig.chans.filter(ch => ch.ty === 'M').sort((a, b) => {
                const order = ['H1', 'H2', 'H3'];
                return order.indexOf(a.tag) - order.indexOf(b.tag);
            });

            return (
                <div className="min-h-screen bg-gray-100 p-6">
                    <div className="max-w-7xl mx-auto bg-white rounded-lg shadow-lg">
                        <div className="bg-gray-200 p-4 rounded-t-lg flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center">
                                    <span className="text-white font-bold">⚡</span>
                                </div>
                                <span className="font-bold text-gray-800">Field QC - EMpower</span>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleCopy} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2">
                                    <Save />
                                    複製
                                </button>
                                <button onClick={handleDownload} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-2">
                                    <Download />
                                    下載
                                </button>
                            </div>
                        </div>

                        <div className="p-4 border-b bg-gray-50">
                            <h2 className="text-lg font-bold">
                                {data.layout.Station_Name} (1d 17h 33m 7s)
                            </h2>
                        </div>

                        <div className="p-4 border-b">
                            <h3 className="font-semibold mb-3">Status</h3>
                            <div className="flex gap-8">
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input 
                                        type="radio" 
                                        checked={status === 'approved'} 
                                        onChange={() => setStatus('approved')}
                                        className="w-4 h-4"
                                    />
                                    <Check />
                                    <span>Approved</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input 
                                        type="radio" 
                                        checked={status === 'unapproved'} 
                                        onChange={() => setStatus('unapproved')}
                                        className="w-4 h-4"
                                    />
                                    <AlertCircle />
                                    <span>Unapproved</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input 
                                        type="radio" 
                                        checked={status === 'rejected'} 
                                        onChange={() => setStatus('rejected')}
                                        className="w-4 h-4"
                                    />
                                    <X />
                                    <span>Rejected</span>
                                </label>
                            </div>
                        </div>

                        <div className="p-4 border-b">
                            <h3 className="font-semibold mb-4 text-lg">Recording Information</h3>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Recording ID:</label>
                                    <input type="text" value={data.instid + '_' + new Date(data.start * 1000).toISOString().split('T')[0]} disabled className="w-full p-2 border rounded bg-gray-50" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Duration:</label>
                                    <input type="text" value="1d 17h 33m 7s" disabled className="w-full p-2 border rounded bg-gray-50" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Survey name:</label>
                                    <input type="text" value={data.layout.Survey_Name} onChange={(e) => updateLayout('Survey_Name', e.target.value)} className="w-full p-2 border rounded" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Station name:</label>
                                    <input type="text" value={data.layout.Station_Name} onChange={(e) => updateLayout('Station_Name', e.target.value)} className="w-full p-2 border rounded" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Operator(s):</label>
                                    <input type="text" value={data.layout.Operator} onChange={(e) => updateLayout('Operator', e.target.value)} className="w-full p-2 border rounded" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Company name:</label>
                                    <input type="text" value={data.layout.Company_Name} onChange={(e) => updateLayout('Company_Name', e.target.value)} className="w-full p-2 border rounded" />
                                </div>
                            </div>
                        </div>

                        <div className="p-4 border-b">
                            <h3 className="font-semibold mb-4 text-lg">Electric Channels</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full border-collapse">
                                    <thead>
                                        <tr className="bg-gray-100">
                                            <th className="border p-2">Channel</th>
                                            <th className="border p-2">Distance (m) to GND<br/>(+) N / E</th>
                                            <th className="border p-2">(-) S / W</th>
                                            <th className="border p-2">Resistance (Ω)<br/>(+) N / E</th>
                                            <th className="border p-2">(-) S / W</th>
                                            <th className="border p-2">Gain</th>
                                            <th className="border p-2">LPF [Hz]</th>
                                            <th className="border p-2">DC [V]</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {eChannels.map((ch, idx) => {
                                            const chIndex = data.chconfig.chans.indexOf(ch);
                                            return (
                                                <tr key={ch.tag}>
                                                    <td className="border p-2 font-semibold">{ch.tag}</td>
                                                    <td className="border p-2">
                                                        <input type="number" step="0.01" value={ch.length1 || 0} onChange={(e) => updateChannel(chIndex, 'length1', parseFloat(e.target.value))} className="w-20 p-1 border rounded" />
                                                    </td>
                                                    <td className="border p-2">
                                                        <input type="number" step="0.01" value={ch.length2 || 0} onChange={(e) => updateChannel(chIndex, 'length2', parseFloat(e.target.value))} className="w-20 p-1 border rounded" />
                                                    </td>
                                                    <td className="border p-2">{ch.pot_p?.toFixed(3) || 'N/A'}</td>
                                                    <td className="border p-2">{ch.pot_n?.toFixed(3) || 'N/A'}</td>
                                                    <td className="border p-2">8 x 1 = x8</td>
                                                    <td className="border p-2">{ch.lp}</td>
                                                    <td className="border p-2">{((ch.dc - 32768) * 0.000038).toFixed(3)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div className="p-4">
                            <h3 className="font-semibold mb-4 text-lg">Magnetic Channels</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full border-collapse">
                                    <thead>
                                        <tr className="bg-gray-100">
                                            <th className="border p-2">Channel</th>
                                            <th className="border p-2">Sensor</th>
                                            <th className="border p-2">Detected</th>
                                            <th className="border p-2">Serial #</th>
                                            <th className="border p-2">Gain</th>
                                            <th className="border p-2">LPF [Hz]</th>
                                            <th className="border p-2">DC [V]</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {mChannels.map((ch, idx) => {
                                            const chIndex = data.chconfig.chans.indexOf(ch);
                                            return (
                                                <tr key={ch.tag}>
                                                    <td className="border p-2 font-semibold">{ch.tag}</td>
                                                    <td className="border p-2">
                                                        <select 
                                                            value={ch.type_name || 'MTC-185'} 
                                                            onChange={(e) => updateChannel(chIndex, 'type_name', e.target.value)}
                                                            className="w-full p-1 border rounded"
                                                        >
                                                            <option value="MTC-185">MTC-185</option>
                                                            <option value="MTC-180">MTC-180</option>
                                                            <option value="MTC-150">MTC-150</option>
                                                        </select>
                                                    </td>
                                                    <td className="border p-2">{ch.type_name || 'MTC-185'}</td>
                                                    <td className="border p-2">
                                                        <input 
                                                            type="text" 
                                                            value={ch.serial || ch.serial_detected || ''} 
                                                            onChange={(e) => updateChannel(chIndex, 'serial', e.target.value)}
                                                            className="w-24 p-1 border rounded"
                                                        />
                                                    </td>
                                                    <td className="border p-2">x{ch.ga}</td>
                                                    <td className="border p-2">{ch.lp}</td>
                                                    <td className="border p-2">{((ch.dc - 32768) * 0.00015).toFixed(2)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {modified && (
                            <div className="p-4 bg-yellow-50 border-t border-yellow-200 text-yellow-800">
                                ⚠️ 檔案已修改，請記得下載儲存
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<MTFieldQCEditor />, document.getElementById('root'));
    </script>
</body>
</html>